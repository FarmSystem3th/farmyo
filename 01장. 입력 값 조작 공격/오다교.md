# 1장 입력 값 조작 공격
- 과거: 일방적인 정보 제공 by HTML 태그 -> 보안 이슈X
- 현재: 사용자가 웹 서버에 요청값 보냄 -> 입력값 교란을 통한 보안 이슈 발생
    - ex) 웹 서버에 명령 실행시키기 위한 운영체제 명령 실행, 데이터 베이스 정보 탈취 위한 SQL 인젝션, 쿠키 정보 탈취 위한 크로스사이트 스크립트, 악의적 파일 업로드 위한 파일 업로드

   이를 방지하기 위해 서버는 입력 값에 대해 검증 절차를 추가한다.


## 1.1 운영체제 명령 실행
- 웹 서비스: 요청 패킷(사용자->서버)과 응답 패킷(서버->사용자)로 구성
    -대부분의 공격은 요청 패킷을 조작
  
- 운영체제 명령 실행 취약점: 사용자가 URL 외 추가적 시스템 명령을 삽입해 요청하는 경우, 서버가 이를 일반 변수 값으로 인식해서 시스템 명령이 실행되어 해당 명령의 결과 값을 출력하는 것
    - 이를 통해 공격자는 시스템 정보를 취득하거나, 시스템 변조할 수 있음
    - 큰 피해를 야기함
    - 운영체제 명령 실행 취약점 존재를 확인하려면 URI의 정상적인 변수 값 뒤에 ;을 추가하고 시스템 명령을 삽입해 서버에 요청하고, 결과 값에 명령의 실행 결과 있는지 테스트함
        - 이때 서버의 파일을 호출하는 filename과 같은 파일 다운로드 변수를 사용할 것
        - 자바 스크립트로 검증하는 경우, 웹 프락시 툴로 우회될 수 있으므로, 실제로 자바 스크립트를 우회하여 확인할 것
        - 운영체제 명령 실행 취약점 확인하는 방법은 URI 변수 값에 http://도메인명/파일명?변수명=변수 값 같은 형식을 사용해 명령 실행 여부를 확인하는 것
        - 취약점 예방을 위해 운영체제 명령 실행 공격의 공격 대상이 되는 취약한 변수를 사용하지 않을 것
        - 취약점 예방을 위해 입력 가능 문자열을 지정하고, 그외 나머지 문자열은 필터링할 것
        - 취약점 예방을 위해 |. ;와 같은 다중 명령 구분자를 필터링할 것
        - 
    - 운영체제 명령 실행 취약점이 존재할 경우 시스템 정보, 디렉터리 구조, 파일 목록 노출되며, 파일의 수정, 삭제, 다운로드가 가능 -> 홈페이지 변조 가능

## 1.2 SQL 인젝션
- 사용자의 게시판 호출 -> 서버는 게시판의 저보를 데이터베이스 서버에 전달 -> 서버는 요청값을 전달받고 사용자에게 보여줌
- SQL 인젝션 취약점: 서버가 게시판 호출하는 변수 값 등의 문자열의 유효성을 검증하지 않아, SQL 쿼리가 데이터베이스 서버로 전송돼 실행되는 취약점
    - 공격자: 로그인 인증 우회, 홈페이지 변조, 내부 자료 유출 시도 가능
    - 가장 빈번한 해킹 종류, 피해도 큼
    - 보안 장비만으로 대응 어려우므로 안전한 소스코딩을 통한 대응 필요
    - SQL 인젝션 취약점으로 인한 데이터베이스 정보 노출은 데이터가 암호화되어도 단방향 암호가 아닌 양방향 암호일 경우, 정보 노출 가능
    - SQL 인젝션 취약점 확인법:
      
      - 정상 URI가 http://도메인명/board/view.php?db=free&no=1&page=1과 같은 경우,

        http://도메인명/board/view.php?db=free&no= **'** 1&page=1나 http://도메인명/board/view.php?db=free&no=1 **'** &page=1처럼 특수 문자를 추가해 0x80040E14 같은 오류 메세지가 출력되는지 확인해볼 수 있음

      -> 이러한 오류 메세지 발생은 입력한 값이 데이터베이스 서버에 전달돼 특수 문자가 데이터베이스의 쿼리문에 영향을 미친다는 증거
      - 게시판이나 검색 창을 통한 확인법: 정상적인 URI 변수 값에 SQL 쿼리를 추가해 참인 조건일 때와 거짓인 조건일 때 출력되는 결과가 다르면 취약점이 존재
          - 이때 입력값을 다양하게 조작하면 데이터베이스 이름, 테이블 이름, 테이블 구조, 실제 데이터까지 확인 가능
            - 이는 블라인드 인젝션: 오류가 발생되는 SQL 쿼리문으로 인한 오류 메세지를 통해 테이블 존재 여부, 테이블명, 필드 개수, 필드명 하나씩 획득
      - 로그인 화면을 통한 확인법: 아이디/패스워드 입력란에 특정 SQL 쿼리를 입력하면 취약점이 있을 경우 로그인이 성공
    - SQL 인젝션 취약점 예방법:
      - 데이터베이스와 연동하는 데 사용되는 모든 입력 변수 값을 점검해, 사용자의 입력 값에 SQL 쿼리문에 이용되는 특수 문자가 포함되지 않게 필터링
      - 쿼리 문자열에 대한 길이를 제한
      - 데이터베이스와 연동하는 스크립트의 모든 변수를 점검해 사용자의 입력 값에 SQL 쿼리문이 허용되지 않는 문자열이 포함되지 않게 필터링
      - 오류 메세지를 사용자에게 보여주지 말 것
      - 데이터베이스의 사용자 권한 제한
     
      - MS-SQL의 경우: 특정 확장 프로시저는 제거할 것, 선처리 구문을 통해 방어 가능
      - PHP의 경우: php.ini 파일 설정 값 중 magic_quotes_gpc 값을 On으로 설정 -> 특수 문자가 동작하지 않게 됨
     
      - 선터리 방법 외, 사용자로부터 전달되는 모든 변수의 입력 값에 대해 특수 문자와 쿼리 예약어를 필터링하거나 '/' 문자나 공백 문자로 치환하는 방법 존재

## 1.3 크로스사이트 스크립팅
- 크로스사이트 스크립팅 취약점: 악성 스크립트를 홈페이지 게시판, 이메일 등으로 유포하여 사용자가 이를 클릭했을 때 악성 스크립트가 실행되게 하는 취약점
  - 공격자: 개인 정보, 로그인 정보 탈취해 2차 공격에 사용, 주로 쿠키 정보 획득 위함
  - 가장 빈번한 해킹 중 하나
- 크로스사이트 스크립트 취약점 확인
  - 통합 검색 창, 게시판 검색 창에 스크립트 구문 입력하거나 게시판에 작성자, 이메일, 제목, 본문 등의 입력 창에 스크립트 구문을 삽입해서 내용을 볼 때 스크립트가 실행되는지 확인하는 방법
    - 검색 창이 검색어 순위를 보여주는 경우, 문제가 발생할 수 있기에 검색 창도 확인할 것
- 크로스사이트 스크립트 취약점 제거: 사용자로부터 받는 모든 입력 값을 서버에서 검증한 후 입력받도록 하는 것
  - 검증 방법: 사용자 입력 가능한 문자를 정해 놓고 나머지 모든 문자를 필터링
    - 특수 문자 그대로 받지 않고, 엔티티 형태로 변경한 후 입력받아야 하고, 받은 문자열에서 replace 같은 문자 변환 함수를 사용해 치환하여 사용할 것

___1.3.1 ASP에서의 크로스사이트 스크립팅 취약점 제거
- Server.HTMLEncode() 함수로 특정 문자열에 대한 HTML 인코딩 수행

___1.3.2 PHP에서의 크로스사이트 스크립팅 취약점 제거
- htmlspecialchars() 함수로 특정 문자열에 대한 HTML 인코딩을 수행

___1.3.3 JSP에서의 크로스사이트 스크립팅 취약점 제거
- replaceAll() 함수를 사용

## 1.4 크로스사이트 요청 변조
- 크로스사이트 요청 변조 취약점: 로그인한 사용자 브라우저가 사용자의 쿠키와 기타 인증 정보를 포함하는 위조된 HTTP 요청을 웹에 전송해 타인이 쿠키 값이나 세션 정보를 의도한 사이트로 보내거나, 전송 값을 글에 삽입하여 해당 게시물을 사용자가 클릭할 때 홈페이지에서 같은 동작이 반복적으로 나타나게 하는 것
  - 일반적으로 악용되는 태그: <Script>, <OBJECT>, <APPLET>, <EMBED>, <IMG>, <FORM>
- 크로스사이트 요청 변조 취약점 확인
  - 게시판 글쓰기 화면에서 내용 입력 후 확인 버튼 클릭했을 때 전송되는 패킷을 웹 프락시 툴로 확인해보면 POST 메소드를 이용해 요청 전달하는 URI 부분과 Body 부분에 전달되는 변수명, 변수 값을 확인 가능. 
    이때 확인된 URI 뒤에 Body 부분의 변수명과 변수 값을 추가하여 전체 URI를 생성한 후 이미지 태그를 이용해 <img> 태그의 src 부분에 생성한 URI를 입력. 그후 화면에 보이지 않게 높이와 너비를 0으로 설정한 태그를 게시판 글쓰기 화면의 내용 부분에 생성한 이미지 태그에 삽입하여 글을 등록.

    취약점이 존재할 경우 해당 게시물을 클릭할 때마다 사용자가 원하지 않는 작업이 수행됨
- 크로스사이트 요청 변조 취약점 해결
  - 모든 입력 값을 서버가 상세히 검증하는 것
    - 헤더, 쿠키, 질의문, 폼 필드, 숨겨진 필드 등 모든 변수를 엄격한 규칙으로 검증 -> HTML을 사용할 경우 태그 내에 ?, & 등이 포함되지 않도록 필터링
  - 특별한 목적 외 HTML 사용하지 못하게 할 것
  - 각 HTTP 요청 내 임의의 토큰을 추가해 토큰 값을 검증

## 1.5 파일 업로드
- 파일 업로드 취약점: 첨부 파일 업로드할 수 있는 게시판에 악의적 스크립트가 포함된 소스 파일을 업로드해 실해시킬 수 있는 취약점
  - 공격자는 이를 통해 악성 스크립트가 업로드된 서버상 경로를 확인하거나, 유출 후 이 경로로 서버상 스크립트를 실행시켜 셸을 획득하여 서버 정보 획득, 파일 열람과 삭제, 홈페이지 변조, 웹 서버 장악 등 가능
  - 가장 피해가 큰 취약점
- 파일 업로드 취약점 확인:
  - 사전 준비로 악성 스크립트 파일 준비하고 이를 복사해 확장자를 이미지 파일로 변경. -> 자바스크립트 필터링을 우회하기 위함. 사용하지 않는다면 우회할 필요 없음.
 
    게시판에 청부 파일로 올리거나 게시판 에디터 기능으로 이미지 파일을 첨부.

    첨부 파일 기능 이용할 경우 웹 셸을 직접 업로드, 자바스크립트를 사용하여 업로드되지 않을 경우에는 이미지 파일 확장자로 변경한 파일을 업로드한 후 웹 프락시 툴을 이용해 전송된 패킷을 원래의 파일명으로 수정하면 업로드 가능.

    글 작성 후 전송되는 패킷을 웹 프락시 툴로 가로채 변수 부분의 a.jpg를 asp_shell.asp로 변경 후 전송 -> 첨부 파일 등록 정보를 이용해 첨부 파일의 경로를 확인한 후, 해당 파일을 호출해 학성 스크립트 파일이 실행되는지 확인.
- 파일 업로드 취약점 대응:
  - 첨부 파일 저장되는 업로드 디렉터리의 실행 권한을 제거해 운여하는 것
  - 업로드 디렉터리를 별도의 드라이브나 별도의 물리적 서버에 분리해 저장하는 것이 안전
  - 웹사이트에서 다운로드 모듈을 작성해 외부로부터 업로드 디렉터리의 직접 URI 호출을 통한 접근이 불가능하게 할 것
  - 파일 저장 시 파일명과 확장자를 추측할 수 없게 파일명을 무작위 문자열로 생성하고, 실행 불가능한 확장자로 변경해 저장할 것
___1.5.1 ASP에서의 파일 업로드 점검

___1.5.2 PHP에서의 파일 업로드 점검

___1.5.3 JSP에서의 파일 업로드 점검
